DROP TABLE IF EXISTS timelines CASCADE;
CREATE TABLE IF NOT EXISTS timelines
(
    id          SERIAL PRIMARY KEY,
    disaster_id UUID         NOT NULL REFERENCES disasters (id) ON DELETE CASCADE,
    event_name  VARCHAR(255) NOT NULL,
    event_time  TIMESTAMP    NOT NULL,
    description TEXT         NOT NULL,
    severity    VARCHAR(50),
    created_at  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at  TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_timelines_disaster_id ON timelines (disaster_id);
CREATE INDEX IF NOT EXISTS idx_timelines_event_time ON timelines (event_time);

-- テーブルとカラムにコメントを追加
COMMENT ON TABLE timelines IS '災害タイムライン管理テーブル - 各災害のイベント履歴を格納';
COMMENT ON COLUMN timelines.id IS 'タイムラインID - 主キー';
COMMENT ON COLUMN timelines.disaster_id IS '災害ID - 関連する災害のID';
COMMENT ON COLUMN timelines.event_name IS 'イベント名 - 発生したイベントの名称';
COMMENT ON COLUMN timelines.event_time IS 'イベント発生日時 - イベントが発生した日時';
COMMENT ON COLUMN timelines.description IS 'イベント説明 - イベントの詳細な説明';
COMMENT ON COLUMN timelines.severity IS 'イベントの深刻度 - 低, 中, 高などの深刻度';
COMMENT ON COLUMN timelines.created_at IS '作成日時 - レコード作成日時';
COMMENT ON COLUMN timelines.updated_at IS '更新日時 - レコード最終更新日時';
COMMENT ON COLUMN timelines.deleted_at IS '削除日時 - 論理削除用のタイムスタンプ';

INSERT INTO disasters (disaster_code,
                       name,
                       prefecture_id,
                       occurred_at,
                       summary,
                       disaster_type,
                       status,
                       impact_level,
                       affected_area_size,
                       estimated_damage_amount,
                       created_at,
                       updated_at)
VALUES
-- 2024年の災害データ
('D2024-001',
 '令和6年7月豪雨による水稲被害',
 13, -- 東京都
 '2024-07-10 14:30:00+09',
 '集中豪雨により水田が冠水し、出穂期の水稲に甚大な被害が発生。約200ヘクタールの水田で倒伏・流失が確認された。',
 '洪水',
 'completed',
 '甚大',
 200.50,
 150000000.00,
 '2024-07-11 09:00:00+09',
 '2024-08-15 16:30:00+09'),
('D2024-002',
 '春季霜害によるりんご園被害',
 2, -- 青森県
 '2024-04-18 03:45:00+09',
 '開花期の異常低温により、県内主要産地のりんご園で花芽・幼果に霜害が発生。収穫量の大幅な減少が予想される。',
 '霜害',
 'in_progress',
 '深刻',
 350.75,
 280000000.00,
 '2024-04-18 08:00:00+09',
 '2024-05-20 14:20:00+09'),
('D2024-003',
 '梅雨期長雨による野菜価格高騰',
 14, -- 神奈川県
 '2024-06-15 00:00:00+09',
 '梅雨前線の停滞により長期間の降雨が続き、露地野菜の生育不良と病害が多発。特にキャベツ、レタスの出荷量が大幅減少。',
 '長雨',
 'under_review',
 '中程度',
 120.30,
 45000000.00,
 '2024-06-20 10:15:00+09',
 '2024-06-25 11:45:00+09'),
('D2024-004',
 'ひょう害によるぶどう栽培被害',
 19, -- 山梨県
 '2024-05-28 16:20:00+09',
 '局地的な雹の襲来により、ぶどう栽培地域で葉や幼果に物理的損傷が発生。特に甲州種の被害が深刻。',
 '雹害',
 'in_progress',
 '深刻',
 85.20,
 120000000.00,
 '2024-05-28 18:30:00+09',
 '2024-06-10 09:20:00+09'),
('D2024-005',
 '台風15号による農業施設損壊',
 12, -- 千葉県
 '2024-09-08 22:15:00+09',
 '台風15号の強風によりビニールハウスや農業倉庫が損壊。施設園芸作物への直接被害も確認されている。',
 '風害',
 'pending',
 '甚大',
 45.80,
 200000000.00,
 '2024-09-09 07:00:00+09',
 '2024-09-09 07:00:00+09'),
-- 2023年の災害データ
('D2023-078',
 '夏季干ばつによる畑作物被害',
 1, -- 北海道
 '2023-08-05 12:00:00+09',
 '記録的な少雨により土壌水分が不足し、じゃがいも、とうもろこし等の畑作物に深刻な生育障害が発生。',
 '干ばつ',
 'completed',
 '深刻',
 1250.00,
 350000000.00,
 '2023-08-10 14:30:00+09',
 '2023-10-31 17:00:00+09'),
('D2023-089',
 'いもち病大発生による稲作被害',
 15, -- 新潟県
 '2023-07-22 00:00:00+09',
 '高温多湿な気象条件下でいもち病が大発生し、県内の水稲作付面積の約15%に被害が拡大。',
 '病害虫',
 'completed',
 '中程度',
 450.25,
 95000000.00,
 '2023-07-25 08:45:00+09',
 '2023-09-15 16:20:00+09'),
('D2023-091',
 '地滑りによる棚田被害',
 17, -- 石川県
 '2023-06-30 04:20:00+09',
 '豪雨による地盤の緩みで山間部の棚田において地滑りが発生。貴重な文化的景観と農地が失われた。',
 '地滑り',
 'completed',
 '深刻',
 12.50,
 25000000.00,
 '2023-06-30 09:00:00+09',
 '2023-08-20 15:30:00+09'),
('D2023-045',
 '春季低温による茶葉品質低下',
 22, -- 静岡県
 '2023-04-12 06:00:00+09',
 '新茶の摘採期に異常低温が継続し、茶葉の生育遅延と品質低下が発生。一番茶の収量・品質ともに例年を大きく下回る。',
 '低温',
 'completed',
 '中程度',
 180.40,
 80000000.00,
 '2023-04-15 11:20:00+09',
 '2023-06-10 14:50:00+09'),
-- 軽微な被害の例
('D2024-006',
 '局地的豪雨による小規模冠水',
 11, -- 埼玉県
 '2024-08-20 15:45:00+09',
 '短時間の集中豪雨により一部農地で冠水が発生したが、排水対応により被害は最小限に抑制された。',
 '洪水',
 'completed',
 '軽微',
 8.30,
 2500000.00,
 '2024-08-20 18:00:00+09',
 '2024-08-22 10:30:00+09'),
('D2024-007',
 'コナガ発生による白菜軽微被害',
 27, -- 大阪府
 '2024-10-05 00:00:00+09',
 '秋冬野菜の生育期にコナガの発生が確認されたが、早期防除により被害は軽微に留まった。',
 '病害虫',
 'in_progress',
 '軽微',
 25.60,
 8000000.00,
 '2024-10-08 09:30:00+09',
 '2024-10-15 14:20:00+09'),
-- 審査中・未着手の災害
('D2024-008',
 '秋季台風による果樹園被害報告',
 34, -- 広島県
 '2024-10-12 08:30:00+09',
 '台風による強風で柿、みかん等の果樹に落果被害が発生した可能性があり、現在被害状況を調査中。',
 '風害',
 'under_review',
 '中程度',
 95.20,
 NULL, -- 査定中のため金額未確定
 '2024-10-15 10:00:00+09',
 '2024-10-20 16:45:00+09'),
('D2024-009',
 '病害虫発生報告（詳細調査待ち）',
 46, -- 鹿児島県
 '2024-11-01 00:00:00+09',
 'さつまいも栽培地域で新たな病害の発生が疑われており、専門機関による詳細な調査が必要な状況。',
 '病害虫',
 'pending',
 '不明',
 NULL, -- 調査前のため面積未確定
 NULL, -- 調査前のため金額未確定
 '2024-11-05 13:20:00+09',
 '2024-11-05 13:20:00+09');

-- タイムラインのダミーデータを挿入
-- disaster_idの値は実際に存在するUUIDに自動的にリンクされます
DO $$
DECLARE
    disaster_id1 UUID;
    disaster_id2 UUID;
    disaster_id3 UUID;
    disaster_id4 UUID;
    disaster_id5 UUID;
BEGIN
    -- 対象となる災害IDを取得（存在するデータから）
    SELECT id INTO disaster_id1 FROM disasters WHERE disaster_code = 'D2024-001' LIMIT 1;
    SELECT id INTO disaster_id2 FROM disasters WHERE disaster_code = 'D2024-002' LIMIT 1;
    SELECT id INTO disaster_id3 FROM disasters WHERE disaster_code = 'D2023-078' LIMIT 1;
    SELECT id INTO disaster_id4 FROM disasters WHERE disaster_code = 'D2024-005' LIMIT 1;
    SELECT id INTO disaster_id5 FROM disasters WHERE disaster_code = 'D2023-091' LIMIT 1;

    -- 令和6年7月豪雨関連のタイムライン
    INSERT INTO timelines (disaster_id, event_name, event_time, description, severity) VALUES
    (disaster_id1, '大雨特別警報発令', '2024-07-09 18:00:00', '気象庁から東京都全域に大雨特別警報が発令された。', '高'),
    (disaster_id1, '河川氾濫警戒情報', '2024-07-10 02:30:00', '〇〇川の水位が上昇し、氾濫警戒水位に到達。', '中'),
    (disaster_id1, '堤防決壊発生', '2024-07-10 05:45:00', '〇〇川の堤防が一部決壊し、周辺農地への浸水が始まった。', '高'),
    (disaster_id1, '浸水被害拡大', '2024-07-10 08:30:00', '浸水エリアが拡大し、水田約150ヘクタールが冠水。', '高'),
    (disaster_id1, '排水作業開始', '2024-07-11 06:00:00', '水位低下に伴い、排水ポンプ車による排水作業が開始された。', '中'),
    (disaster_id1, '被害状況調査開始', '2024-07-12 09:00:00', '農林水産省と都の合同チームによる被害状況調査が開始された。', '低');

    -- 春季霜害関連のタイムライン
    INSERT INTO timelines (disaster_id, event_name, event_time, description, severity) VALUES
    (disaster_id2, '低温注意報発令', '2024-04-17 16:00:00', '翌朝の冷え込みに関する低温注意報が発令された。', '低'),
    (disaster_id2, '霜害発生', '2024-04-18 04:30:00', '早朝の気温が-2℃まで低下し、りんご園に広範囲の霜被害が発生。', '高'),
    (disaster_id2, '被害第一報', '2024-04-18 08:30:00', 'JAから県に対して霜害の第一報が入った。開花中の花芽に甚大な被害。', '高'),
    (disaster_id2, '緊急対策会議', '2024-04-18 13:00:00', '県庁で関係機関による緊急対策会議が開催された。', '中'),
    (disaster_id2, '専門家チーム派遣', '2024-04-19 10:00:00', '農業技術専門家チームが被害状況の詳細調査のため現地に派遣された。', '中'),
    (disaster_id2, '被害状況報告書提出', '2024-04-25 15:00:00', '詳細な被害状況と今後の見通しに関する報告書が県に提出された。', '低');

    -- 夏季干ばつ関連のタイムライン
    INSERT INTO timelines (disaster_id, event_name, event_time, description, severity) VALUES
    (disaster_id3, '少雨傾向の警告', '2023-07-20 10:00:00', '気象庁から長期間の少雨傾向が続く予報が発表された。', '低'),
    (disaster_id3, '干ばつ注意報', '2023-07-30 12:00:00', '北海道南部を中心に干ばつ注意報が発令された。', '中'),
    (disaster_id3, '生育障害の発生', '2023-08-05 09:00:00', 'じゃがいも、とうもろこしなどの畑作物に生育障害が発生し始めた。', '中'),
    (disaster_id3, '断水対策開始', '2023-08-10 08:00:00', '一部地域で農業用水の取水制限が始まり、断水対策が開始された。', '高'),
    (disaster_id3, '緊急灌水支援', '2023-08-15 14:00:00', '自衛隊による給水支援と緊急灌水作業が開始された。', '高'),
    (disaster_id3, '被害状況確定', '2023-09-20 15:30:00', '干ばつによる収穫量減少と品質低下の最終的な被害状況が確定した。', '中');

    -- 台風15号関連のタイムライン
    INSERT INTO timelines (disaster_id, event_name, event_time, description, severity) VALUES
    (disaster_id4, '台風発生', '2024-09-05 10:00:00', '南の海上で台風15号が発生。進路予測では日本に接近する見込み。', '低'),
    (disaster_id4, '暴風警報発令', '2024-09-08 12:00:00', '千葉県全域に暴風警報が発令された。', '中'),
    (disaster_id4, '農業施設対策指示', '2024-09-08 14:30:00', '県からビニールハウスなど農業施設の補強・避難対策の指示が出された。', '中'),
    (disaster_id4, '台風最接近', '2024-09-08 22:00:00', '台風15号が千葉県に最接近。最大瞬間風速40m/sを記録。', '高'),
    (disaster_id4, '施設被害発生', '2024-09-08 23:30:00', '強風によりビニールハウスの倒壊や農業倉庫の屋根損壊が発生。', '高'),
    (disaster_id4, '被害状況調査', '2024-09-09 07:00:00', '台風通過後、県とJAによる被害状況の緊急調査が開始された。', '中');

    -- 地滑り関連のタイムライン
    INSERT INTO timelines (disaster_id, event_name, event_time, description, severity) VALUES
    (disaster_id5, '大雨警報発令', '2023-06-29 15:00:00', '石川県に大雨警報が発令された。', '中'),
    (disaster_id5, '土砂災害警戒情報', '2023-06-29 20:30:00', '土砂災害警戒情報が発表され、警戒レベル4相当に引き上げられた。', '高'),
    (disaster_id5, '避難指示発令', '2023-06-29 22:00:00', '山間部の住民に対して避難指示が発令された。', '高'),
    (disaster_id5, '地滑り発生', '2023-06-30 04:20:00', '山間部の棚田地域で大規模な地滑りが発生。', '高'),
    (disaster_id5, '二次災害防止措置', '2023-06-30 10:00:00', '専門家チームによる二次災害防止のための緊急措置が開始された。', '中'),
    (disaster_id5, '復旧計画策定開始', '2023-07-05 13:00:00', '被災した棚田の復旧計画策定のための検討会が開催された。', '低');
END $$;
